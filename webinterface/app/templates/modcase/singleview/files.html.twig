{% block body %}
    <style>
        #files-viewer > div {
             margin: 8px;
             width: 20rem;
         }
        #files-viewer .card-img-top {
            width: 100%;
            height: 10vw;
            object-fit: cover;
        }
    </style>
    {% if modcase.guildId in basic_data.loggedInUser.modGuilds or basic_data.loggedInUser.isAdmin %}
        <div class="mt-3 d-flex flex-row align-items-baseline" id="file-upload-container">
            <button class="btn btn-success flex-shrink-0" onclick="sendFile()">
                Upload
            </button>
            <div class="input-group flex-shrink-1">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="file-input"
                            aria-describedby="file-input-label">
                    <label class="custom-file-label" for="file-input">Choose file</label>
                </div>
            </div>
        </div>
    {% endif %}
    {% if files.names|default([]) %}
        <div class="d-flex flex-wrap justify-content-center" id="files-viewer">
            {% for file in files.names|default([]) %}
                <div class="card flex-shrink-1">
                    {% if file|split('.')|last|lower in ['jpg', 'png', 'jpeg', 'gif', 'ico', 'tif', 'tiff'] %}
                    <div class="view overlay">
                        <img class="card-img-top" src="/api/v1/guilds/{{ modcase.guildId }}/modcases/{{ modcase.caseId }}/files/{{ file }}"
                                alt="Card image cap">
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ file|split('_', 3)|last }}</h5>
                        <div class="d-flex flex-row flex-wrap justify-content-center">
                            <a href="/api/v1/guilds/{{ modcase.guildId }}/modcases/{{ modcase.caseId }}/files/{{ file }}"
                                class="btn btn-primary flex-shrink-1" target="_blank">
                                View
                            </a>
                            {% if modcase.guildId in basic_data.loggedInUser.modGuilds or basic_data.loggedInUser.isAdmin %}
                                <button class="btn btn-danger" id="filedelete-{{ file }}" onclick="deleteFile(this)">
                                    Delete
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="card rounded mt-2">
            <div class="card-body">
                <h4 class="card-title"><a>No files uploaded yet.</a></h4>
            </div>
        </div>
    {% endif %}
{% endblock body %}

{% block scriptblock %}
<script>
    function deleteFile(obj) {
        let elementId = $(obj).attr('id');
        let fileName = elementId.slice(elementId.indexOf('-') + 1);

        $.ajax({
            type: "DELETE",
            url: "/api/v1/guilds/{{ modcase.guildId|default }}/modcases/{{ modcase.caseId|default }}/files/" + fileName,
            success: function (data) {
                location.reload();
            },
            error: function (errMsg) {
                handleRequestError(errMsg, "Deleting file failed")
            }
        });
    }   

    function sendFile() {
        let files = ($('#file-input')[0].files);
        if (files.length === 0) {
            return;
        }
        let formData = new FormData();
        formData.append('File', files[0]);

        $.ajax({
            type: "POST",
            url: "/api/v1/guilds/{{ modcase.guildId|default }}/modcases/{{ modcase.caseId|default }}/files",
            data: formData,
            contentType: false,
            processData: false,
            success: function(data){ location.reload() },
            error: function(errMsg) {
                handleRequestError(errMsg, "Uploading file failed")
            }
        });
    }
</script>
{% endblock %}
