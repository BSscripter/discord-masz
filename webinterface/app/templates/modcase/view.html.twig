{% extends 'base.html.twig' %}
{% block body %}
    {% include 'navbar.html.twig' %}

    <style>
        .hiddencolumn {
            display: none;
        }
    </style>

    <div class="container">
        {% if modcase|default %}
            <div class="d-flex justify-content-start align-items-start flex-wrap">

                <!-- Title + Guild -->
                <div class="flex-grow-1">
                    <h4 class="font-weight-bold"><span class="display-4">#{{ modcase.caseId }}</span> {{ modcase.title }}
                    </h4>

                    <div class="d-flex align-items-lg-center">
                        {% if guild|default %}
                        <img
                                src="https://cdn.discordapp.com/icons/{{ guild.id }}/{{ guild.icon }}.png"
                                class="rounded-circle z-depth-0 mr-1"
                                alt="avatar image"
                                height="35"
                        />
                        <span class="font-weight-bold">Guild: {{ guild.name }}
                            {% endif %}
                        <span class="text-black-50">({{ modcase.guildId }})</span></span>
                    </div>
                </div>

                <!-- User icon -->
                {% if user|default %}
                    <div class="align-self-end mr-4">
                        <img
                                src="{{ user.imageUrl }}"
                                class="rounded-circle z-depth-0 mr-1"
                                alt="avatar image"
                                height="128"
                        />
                    </div>
                {% endif %}

                <!-- Edit and delete buttons -->
                <div class="d-flex flex-column align-self-end">
                    <a type="button" class="btn btn-primary"
                       href="/api/v1/modcases/{{ modcase.guildId }}/{{ modcase.caseId }}" target="_blank">See raw case
                        data</a>
                    {% if modcase.guildId in basic_data.loggedInUser.modGuilds or basic_data.loggedInUser.isAdmin %}
                        <a type="button" class="btn btn-warning" href="/modcases/{{ modcase.guildId }}/{{ modcase.caseId }}/edit">Edit this case</a>
                        <a type="button" class="btn btn-danger" href="#">Delete this case</a>
                    {% endif %}
                </div>

            </div>
            <br>

            <!-- Labels -->
            <div class="row mb-1 ml-2">
                <div class="d-flex justify-content-between">
                    {% for label in modcase.labels|default([]) %}
                        <a href="/modcases/{{ modcase.guildId }}?label={{ label }}">
                            <h3>
                                <span type="button" class="badge badge-pill badge-info mr-1">{{ label }}</span>
                            </h3>
                        </a>
                    {% endfor %}
                </div>
            </div>

            <!-- Table -->
            <div class="row">

                <!-- user info -->
                <div class="col-xl-6 col-lg-6 col-md-6 sm-col-12">
                    <h4 class="font-weight-bold">User information</h4>

                    <table class="table">
                        <tbody>
                        <tr>
                            <th class="font-weight-bold">Punishment</th>
                            <td>
                                <h3>
                                    <span class="badge badge-danger">{{ modcase.punishment }}</span>
                                </h3>
                            </td>
                        </tr>
                        <tr>
                            <th class="font-weight-bold">UserID</th>
                            <td>
                                <a href="/modcases/{{ modcase.guildId }}?userId={{ modcase.userId }}">
                                    {{ modcase.userId }}
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <th class="font-weight-bold">Username</th>
                            <td class="font-weight-bold">
                                <a href="/modcases/{{ modcase.guildId }}?userId={{ modcase.userId }}">
                                    {{ modcase.username }}
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <th class="font-weight-bold">Nickname</th>
                            <td>
                                <a href="/modcases/{{ modcase.guildId }}?userId={{ modcase.userId }}">
                                    {% if modcase.nickname != '' %}
                                        {{ modcase.nickname }}
                                    {% else %}
                                        <span class="text-danger font-weight-bold">Not set.</span>
                                    {% endif %}
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- case info -->
                <div class="col-xl-6 col-lg-6 col-md-6 sm-col-12">
                    <h4 class="font-weight-bold">Case information</h4>
                    <table class="table">
                        <tbody>
                        <tr>
                            <th class="font-weight-bold">Title</th>
                            <td class="font-weight-bold">{{ modcase.title }}</td>
                        </tr>
                        <tr>
                            <th class="font-weight-bold">Severity</th>
                            <td>{{ modcase.severity }}</td>

                        </tr>
                        <tr>
                            <th class="font-weight-bold">Created at</th>
                            <td>{{ modcase.createdAt }}</td>
                        </tr>
                        <tr>
                            <th class="font-weight-bold">Occured at</th>
                            <td>{{ modcase.occuredAt }}</td>
                        </tr>
                        <tr>
                            <th class="font-weight-bold">Moderator</th>
                            <td class="font-weight-bold">
                                <!-- mod info -->
                                <a href="/modcases/{{ modcase.guildId }}?modId={{ modcase.modId }}">
                                    {% if moderator|default %}
                                        <img
                                                src="{{ moderator.imageUrl }}"
                                                class="rounded-circle z-depth-0 mr-1"
                                                alt="avatar image"
                                                height="35"
                                        /> {{ moderator.username }}
                                    {% endif %}
                                    <span class="text-black-50">({{ modcase.modId }})</span>
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <th class="font-weight-bold">Last Edit by Moderator</th>
                            <td class="font-weight-bold">
                                <!-- last mod info -->
                                <a href="/modcases/{{ modcase.guildId }}?modId={{ lastModerator.id }}">
                                    {% if lastModerator|default %}
                                        <img
                                                src="{{ lastModerator.imageUrl }}"
                                                class="rounded-circle z-depth-0 mr-1"
                                                alt="avatar image"
                                                height="35"
                                        /> {{ lastModerator.username }}
                                    {% endif %}
                                    <span class="text-black-50">({{ modcase.lastEditedByModId }})</span><br/> {{ modcase.lastEditedAt }}
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <br>
            </div>

            <!-- Description -->
            <div class="mb-3">
                <h4 class="font-weight-bold">Full case description</h4>
                <hr/>
                <span style="white-space: pre-wrap;" class="text-monospace">{{ modcase.description }}</span>
            </div>

            <h4 class="font-weight-bold">Comments ({{ modcase.comments|length }})</h4>
            <hr/>
            <div class="d-flex flex-column flex-wrap justify-content-between mt-3">
                {% if modcase.comments|default %}
                    {% for comment in modcase.comments|default([]) %}
                        <div class="card mb-3">
                            <div class="card-body d-flex flex-row">
                                <div class="align-self-start mr-3">
                                    <img
                                            src="{{ comment.discordUser.imageUrl }}"
                                            class="card-img rounded-circle z-depth-0 mr-1"
                                            alt="avatar icon"
                                            height="35"
                                            style="width: unset"
                                    />
                                </div>
                                <div class="flex-grow-1">
                                    <!-- Title -->
                                    <h4 class="card-title">
                                        {{ comment.discordUser.username|default(comment.userId) }}
                                    </h4>

                                    <!-- Text -->
                                    <div class="card-text">
                                        <span style="white-space: pre-wrap;" class="text-monospace font-small">{{ comment.createdAt }}</span><br/>
                                        <span style="white-space: pre-wrap;" class="text-monospace">{{ comment.message }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-text">
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
                <div class="row">
                    <div class="col-md-12">
                        <div class="md-form form-group">
                            <input type="text" class="form-control" id="newComment">
                            <label for="newComment">Comment</label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-md" onclick="sendComment()">
                    Post comment
                </button>
            </div>

            <div class="mt-3"></div>

        {% endif %}
        <div role="alert" aria-live="assertive" aria-atomic="true" class="toast" data-autohide="false" id="notification" style="min-width:100%">
            <div class="toast-header">
                <svg class=" rounded mr-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg"
                     preserveAspectRatio="xMidYMid slice" focusable="false" role="img">
                    <rect fill="#007aff" width="100%" height="100%" id="notificationColor" /></svg>
                <strong class="mr-auto" id="notificationTitle">Post comment</strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body" id="notificationBody">
                Hello, world! This is a toast message.
            </div>
        </div>
    </div>
{% endblock body %}

{% block scriptblock %}

    <script>
        $(document).ready(function () {
            $('#newComment').keydown(function(e){
                if(e.keyCode === 13)
                {
                    $(this).trigger('sendComment');
                }
            })
        });

        function sendComment() {
            let msg = $('#newComment').val();

            if (!msg) {
                return;
            }

            let body = {
                'message': msg
            };

            $.ajax({
                type: "POST",
                url: "/api/v1/modcases/{{ modcase.guildId|default }}/{{ modcase.caseId|default }}/comments",
                data: JSON.stringify(body),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(data){location.reload()},
                error: function(errMsg) {
                    console.log(errMsg);
                    $('#notificationColor').attr('fill', '#ac000f');
                    $('#notificationTitle').text('Posting comment failed');
                    $('#notificationBody').text(errMsg.status + ': ' + errMsg.responseText);
                    $('#notification').toast('show');
                }
            });
        }
    </script>
{% endblock %}
